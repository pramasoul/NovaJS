!function(t){"use strict";"function"==typeof define&&define.amd?define(["RBush","SAT"],t):"object"==typeof exports?module.exports=t(require("rbush"),require("sat")):window.Crash=t(window.rbush,window.SAT)}(function(t,e){"use strict";var o=[],s=[],i=function(o){o||(o={}),this.__options={maxEntries:o.maxEntries||9,maxChecks:"number"==typeof o.maxChecks?o.maxChecks:100,overlapLimit:"number"==typeof o.overlapLimit||o.overlapLimit===!1?o.overlapLimit:.5},this.rbush=new t(this.__options.maxEntries,[".aabb.x1",".aabb.y1",".aabb.x2",".aabb.y2"]),this.MAX_CHECKS=this.__options.maxChecks,this.OVERLAP_LIMIT=this.__options.overlapLimit,this.RESPONSE=new e.Response,this.BREAK=!1,this.__moved=[],this.__listeners=[],this.createColliders(this)};return i.RBush=i.prototype.RBush=t,i.SAT=i.prototype.SAT=e,i.Vector=i.prototype.Vector=e.Vector,i.V=i.prototype.V=e.Vector,i.Response=i.prototype.Response=e.Response,i.extend=i.prototype.extend=function(t,e){t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})},i.getTestString=i.prototype.getTestString=function(t,e){return"circle"===t?"circle"===e?"testCircleCircle":"testCirclePolygon":"circle"===e?"testPolygonCircle":"testPolygonPolygon"},i.prototype.reset=function(){return this.clear(),this.__listeners=[],this.BREAK=!1,this.MAX_CHECKS=this.__options.maxChecks,this.OVERLAP_LIMIT=this.__options.overlapLimit,this.RESPONSE.clear(),this},i.prototype.onCollision=function(t){return this.__listeners.push(t),this},i.prototype.offCollision=function(t){var e=this.__listeners.indexOf(t);return e>-1&&this.__listeners.splice(e,1),this},i.prototype.__onCollision=function(t,e,o){for(var s=0,i=this.__listeners.length;i>s;s++)this.__listeners[s].call(this,t,e,o,this.cancel);return this},i.prototype.cancel=function(){return this.BREAK=!0,!1},i.prototype.insert=function(t){return this.rbush.insert(t),this},i.prototype.remove=function(t){return this.rbush.remove(t),this},i.prototype.all=function(){return this.rbush.all()},i.prototype.search=function(t){o[0]=t.aabb.x1,o[1]=t.aabb.y1,o[2]=t.aabb.x2,o[3]=t.aabb.y2;for(var e=this.rbush.search(o),s=0;s<e.length;s++)e[s]===t&&e.splice(s,1);return e},i.prototype.clear=function(){return this.rbush.clear(),this.__moved=[],this},i.prototype.addToMoved=function(t){return-1===this.__moved.indexOf(t)&&this.__moved.push(t),this},i.prototype.update=function(t){return this.updateAABB(t),this.remove(t),this.insert(t),this},i.prototype.moved=function(t){return this.update(t),this.addToMoved(t),this},i.updateAABB=i.prototype.updateAABB=function(t){switch(t.type){case"polygon":return this.updateAABBPolygon(t);case"box":return this.updateAABBBox(t);case"circle":return this.updateAABBCircle(t);case"point":return this.updateAABBPoint(t)}},i.updateAABBPolygon=i.prototype.updateAABBPolygon=function(t){for(var e=t.aabb,o=t.sat.pos,s=t.sat.calcPoints,i=s.length,r=s[0].x,n=s[0].y,h=s[0].x,p=s[0].y,a=1;i>a;a++){var u=s[a];u.x<r?r=u.x:u.x>h&&(h=u.x),u.y<n?n=u.y:u.y>p&&(p=u.y)}e.x1=o.x+r,e.y1=o.y+n,e.x2=o.x+h,e.y2=o.y+p},i.updateAABBCircle=i.prototype.updateAABBCircle=function(t){var e=t.aabb,o=t.sat.r,s=t.sat.pos;e.x1=s.x-o,e.y1=s.y-o,e.x2=s.x+o,e.y2=s.y+o},i.updateAABBPoint=i.prototype.updateAABBPoint=function(t){var e=t.aabb,o=t.sat.pos;e.x1=e.x2=o.x,e.y1=e.y2=o.x},i.updateAABBBox=i.prototype.updateAABBBox=function(t){var e=t.sat.calcPoints,o=t.aabb;o.x1=e[0].x,o.y1=e[0].y,o.x2=e[2].x,o.y2=e[2].y},i.test=i.prototype.test=function(t,o,s){var s=s||this.RESPONSE,i=this.getTestString(t.type,o.type);return s.clear(),e[i](t.sat,o.sat,s)},i.prototype.testAll=function(t,o){var o=o||this.RESPONSE,s=this.search(t);t:for(var i=0,r=s.length;r>i;i++){var n=s[i],h=this.getTestString(t.type,n.type);if(o.clear(),e[h](t.sat,n.sat,o)&&(!this.OVERLAP_LIMIT||Math.abs(o.overlap)>this.OVERLAP_LIMIT)&&(this.__onCollision(t,n,o),this.BREAK))break t}t.lastPos.copy(t.pos);var p=this.BREAK;return this.BREAK=!1,!p},i.prototype.check=function(t){for(var e=0;this.__moved.length&&e<this.MAX_CHECKS;){var o=this.__moved.pop(),i=s.indexOf(o);-1===i&&s.push(o),this.testAll(o,t),e++}for(var e=0,r=s.length;r>e;e++)s[e].lastCheckedPos.copy(s[e].pos);return s.length=0,this},i.prototype.checkAll=function(t){for(var e=this.all(),o=0,s=e.length;s>o;o++)this.testAll(e[o],t);return this.check(t),this},i.createColliders=i.prototype.createColliders=function(t){var o=t.Collider=function(e,o,s,i){return this.type=e,this.sat=o,this.data=i,this.pos=this.sat.pos,this.lastPos=this.pos.clone(),this.lastCheckedPos=this.pos.clone(),this.aabb={},t.updateAABB(this),s&&t.insert(this),this};o.prototype.insert=function(){return t.insert(this),this},o.prototype.remove=function(){return t.remove(this),this},o.prototype.update=function(){return t.update(this),this},o.prototype.updateAABB=function(){return t.updateAABB(this),this},o.prototype.moved=function(){return t.moved(this),this},o.prototype.search=function(){return t.search(this)},o.prototype.setData=function(t){return this.data=t,this},o.prototype.getData=function(){return this.data},o.prototype.moveTo=function(t,e){return this.sat.pos.x=t,this.sat.pos.y=e,this.moved(),this},o.prototype.moveBy=o.prototype.move=function(t,e){return this.sat.pos.x+=t,this.sat.pos.y+=e,this.moved(),this};var s=t.Polygon=function(t,s,i,r){var n=new e.Polygon(t,s);return o.call(this,"polygon",n,i,r),this};i.extend(s,o),s.prototype.setPoints=function(t){return this.sat.setPoints(t),this.moved(),this},s.prototype.setAngle=function(t){return this.sat.setAngle(t),this.moved(),this},s.prototype.setOffset=function(t){return this.sat.setOffset(t),this.moved(),this},s.prototype.rotate=function(t){return this.sat.rotate(t),this.moved(),this};var r=t.Circle=function(t,s,i,r){var n=new e.Circle(t,s);return o.call(this,"circle",n,i,r),this};i.extend(r,o);var n=t.Point=function(t,s,i){var r=new e.Box(t,1,1).toPolygon();return o.call(this,"point",r,s,i),this};i.extend(n,o);var h=t.Box=function(t,s,i,r,n){var h=new e.Box(t,s,i).toPolygon();return o.call(this,"box",h,r,n),this};i.extend(h,o)},i});